'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = normalizeHTML;

var _patchAnchorElements = require('./patchAnchorElements');

var _patchAnchorElements2 = _interopRequireDefault(_patchAnchorElements);

var _patchBreakElements = require('./patchBreakElements');

var _patchBreakElements2 = _interopRequireDefault(_patchBreakElements);

var _patchElementInlineStyles = require('./patchElementInlineStyles');

var _patchElementInlineStyles2 = _interopRequireDefault(_patchElementInlineStyles);

var _patchListElements = require('./patchListElements');

var _patchListElements2 = _interopRequireDefault(_patchListElements);

var _patchParagraphElements = require('./patchParagraphElements');

var _patchParagraphElements2 = _interopRequireDefault(_patchParagraphElements);

var _patchStyleElements = require('./patchStyleElements');

var _patchStyleElements2 = _interopRequireDefault(_patchStyleElements);

var _patchTableElements = require('./patchTableElements');

var _patchTableElements2 = _interopRequireDefault(_patchTableElements);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function normalizeHTML(html) {
  var body = null;

  var sourceIsPage = /<body[\s>]/i.test(html);

  // Provides a dom node that will not execute scripts
  // https://developer.mozilla.org/en-US/docs/Web/API/DOMImplementation.createHTMLDocument
  // https://developer.mozilla.org/en-US/Add-ons/Code_snippets/HTML_to_DOM
  if (typeof document !== 'undefined' && document.implementation && document.implementation.createHTMLDocument) {
    html = html.replace(/_+/g, function (matched) {
      // This is a workround to convert "_______" into none-wrapped text
      // that apppears like a horizontal line.
      if (matched && matched.length >= 20) {
        // needs extra space after it so user can escape the <nobr />.
        matched = '<nobr>' + String(matched) + '</nobr> ';
      }
      return matched;
    });

    var doc = document.implementation.createHTMLDocument('');
    doc.open();
    doc.write(html);
    doc.close();
    // styles.
    (0, _patchStyleElements2.default)(doc);
    (0, _patchElementInlineStyles2.default)(doc);
    // contents.
    (0, _patchAnchorElements2.default)(doc);
    (0, _patchBreakElements2.default)(doc);
    (0, _patchListElements2.default)(doc);
    (0, _patchParagraphElements2.default)(doc);
    (0, _patchTableElements2.default)(doc);
    body = doc.getElementsByTagName('body')[0];

    if (body && sourceIsPage) {
      // Source HTML contains <body />, assumes this to be a complete
      // page HTML. Assume this <body /> may contain the style that indicates
      // page's layout.
      var frag = doc.createElement('html');
      frag.appendChild(body);
      return frag.innerHTML;
    }
  }

  if (!body) {
    // <body /> should alway be generated by doc.
    return 'Unsupported HTML content';
  }

  // HTML snippet only.
  return '<body>' + body.innerHTML + '</body>';
}